<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Mechanical Duo – Stable Movement & Repair</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
html,body{margin:0;overflow:hidden;background:#000;touch-action:none}
#ui{position:fixed;inset:0;pointer-events:none}
#joystick{position:absolute;left:20px;bottom:20px;width:140px;height:140px;border-radius:50%;background:rgba(255,255,255,.08);pointer-events:auto}
#stick{position:absolute;left:50%;top:50%;width:60px;height:60px;margin:-30px;border-radius:50%;background:rgba(255,255,255,.4)}
#interact{position:absolute;right:20px;bottom:40px;padding:14px 22px;background:#ff4444;color:#fff;border-radius:12px;font-size:18px;pointer-events:auto}
</style>
</head>
<body>

<div id="ui">
  <div id="joystick"><div id="stick"></div></div>
  <div id="interact">تفاعل</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
/* ===== Scene ===== */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x202020);

/* ===== Camera ===== */
const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,1000);

/* ===== Renderer ===== */
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

/* ===== Light ===== */
scene.add(new THREE.AmbientLight(0xffffff,.5));
const sun=new THREE.DirectionalLight(0xffffff,1);
sun.position.set(5,10,5);
scene.add(sun);

/* ===== Floor ===== */
const floor=new THREE.Mesh(
  new THREE.PlaneGeometry(200,200),
  new THREE.MeshStandardMaterial({color:0x555555})
);
floor.rotation.x=-Math.PI/2;
scene.add(floor);

/* ===== Player ===== */
const player=new THREE.Mesh(
  new THREE.CapsuleGeometry(.4,1,4,8),
  new THREE.MeshStandardMaterial({color:0x00aaff})
);
player.position.y=1;
scene.add(player);

/* ===== Car ===== */
const car=new THREE.Mesh(
  new THREE.BoxGeometry(2,1,4),
  new THREE.MeshStandardMaterial({color:0xaa0000})
);
car.position.set(0,.5,-6);
scene.add(car);

/* ===== State ===== */
let state="walk";

/* ===== Movement ===== */
let joyX=0,joyY=0,moving=false;
let yaw=0,pitch=0;
let moveAngle=0;
const velocity=new THREE.Vector3();

/* ===== Joystick ===== */
const joy=document.getElementById("joystick");
const stick=document.getElementById("stick");

joy.addEventListener("pointerdown",e=>{
  moving=true;
  moveAngle=yaw;
});
joy.addEventListener("pointermove",e=>{
  if(!moving||state!=="walk")return;
  const r=joy.getBoundingClientRect();
  let x=e.clientX-(r.left+r.width/2);
  let y=e.clientY-(r.top+r.height/2);
  const d=Math.min(50,Math.hypot(x,y));
  const a=Math.atan2(y,x);
  x=Math.cos(a)*d; y=Math.sin(a)*d;
  stick.style.transform=`translate(${x}px,${y}px)`;
  joyX=x/50; joyY=y/50;
});
joy.addEventListener("pointerup",()=>{
  moving=false;
  joyX=joyY=0;
  stick.style.transform="";
});

/* ===== Camera Look ===== */
let look=false,lx=0,ly=0;
renderer.domElement.addEventListener("pointerdown",e=>{
  if(e.clientX<innerWidth*.5||state!=="walk")return;
  look=true; lx=e.clientX; ly=e.clientY;
});
addEventListener("pointermove",e=>{
  if(!look)return;
  yaw-=(e.clientX-lx)*.005;
  pitch-=(e.clientY-ly)*.005;
  pitch=Math.max(-.5,Math.min(.4,pitch));
  lx=e.clientX; ly=e.clientY;
});
addEventListener("pointerup",()=>look=false);

/* ===== Interact ===== */
document.getElementById("interact").onclick=()=>{
  if(state==="walk"){
    state="repair";
    player.visible=false;
    velocity.set(0,0,0);
    car.material.color.set(0x00ff00);
  }else{
    state="walk";
    player.visible=true;
    car.material.color.set(0xaa0000);
  }
};

/* ===== Loop ===== */
function animate(){
  requestAnimationFrame(animate);

  if(state==="walk" && moving){
    const sin=Math.sin(moveAngle),cos=Math.cos(moveAngle);
    velocity.x=(joyX*cos-joyY*sin)*.08;
    velocity.z=(joyX*sin+joyY*cos)*.08;
  }else velocity.multiplyScalar(.85);

  player.position.add(velocity);

  if(velocity.length()>.01)
    player.rotation.y=Math.atan2(velocity.x,velocity.z);

  if(state==="walk"){
    const camOffset=new THREE.Vector3(0,2,5);
    camOffset.applyAxisAngle(new THREE.Vector3(0,1,0),yaw);
    camera.position.copy(player.position).add(camOffset);
    camera.lookAt(player.position.x,player.position.y+1,player.position.z);
  }else{
    camera.position.lerp(new THREE.Vector3(0,2,-4),.1);
    camera.lookAt(car.position);
  }

  renderer.render(scene,camera);
}
animate();

addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
