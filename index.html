<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Mechanical Duo – Movement & Camera Stable</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
html,body { margin:0; padding:0; overflow:hidden; background:#000; touch-action:none; }
#ui {
  position:fixed; inset:0; pointer-events:none;
}
#joystick {
  position:absolute;
  left:20px; bottom:20px;
  width:140px; height:140px;
  border-radius:50%;
  background:rgba(255,255,255,0.08);
  pointer-events:auto;
}
#stick {
  position:absolute;
  left:50%; top:50%;
  width:60px; height:60px;
  margin:-30px;
  border-radius:50%;
  background:rgba(255,255,255,0.4);
}
#interact {
  position:absolute;
  right:20px; bottom:40px;
  padding:14px 22px;
  background:#ff4444;
  color:#fff;
  border-radius:12px;
  font-size:18px;
  pointer-events:auto;
}
</style>
</head>

<body>
<div id="ui">
  <div id="joystick"><div id="stick"></div></div>
  <div id="interact">تفاعل</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
/* ====== مشهد ====== */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x202020);

/* ====== كاميرا ====== */
const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000);

/* ====== ريندر ====== */
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

/* ====== إضاءة ====== */
scene.add(new THREE.AmbientLight(0xffffff,0.5));
const sun = new THREE.DirectionalLight(0xffffff,1);
sun.position.set(5,10,5);
scene.add(sun);

/* ====== أرض ====== */
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(200,200),
  new THREE.MeshStandardMaterial({color:0x555555})
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

/* ====== لاعب (مجسم مؤقت) ====== */
const player = new THREE.Mesh(
  new THREE.CapsuleGeometry(0.4,1.0,4,8),
  new THREE.MeshStandardMaterial({color:0x00aaff})
);
player.position.y = 1;
scene.add(player);

/* ====== سيارة ====== */
const car = new THREE.Mesh(
  new THREE.BoxGeometry(2,1,4),
  new THREE.MeshStandardMaterial({color:0xaa0000})
);
car.position.set(0,0.5,-6);
scene.add(car);

/* ====== متغيرات الحركة ====== */
let joyX=0, joyY=0;
let moving=false;
let yaw=0, pitch=0;
let moveDir = new THREE.Vector3();
const velocity = new THREE.Vector3();

/* ====== جويستيك ====== */
const joy = document.getElementById("joystick");
const stick = document.getElementById("stick");

joy.addEventListener("pointerdown",e=>{
  joy.setPointerCapture(e.pointerId);
  moving=true;
});
joy.addEventListener("pointermove",e=>{
  if(!moving) return;
  const r = joy.getBoundingClientRect();
  let x = e.clientX - (r.left+r.width/2);
  let y = e.clientY - (r.top+r.height/2);
  const d = Math.min(50,Math.hypot(x,y));
  const a = Math.atan2(y,x);
  x = Math.cos(a)*d; y = Math.sin(a)*d;
  stick.style.transform = `translate(${x}px,${y}px)`;
  joyX = x/50;
  joyY = y/50;
});
joy.addEventListener("pointerup",()=>{
  moving=false;
  joyX=joyY=0;
  stick.style.transform="";
});

/* ====== تحريك الكاميرا باللمس ====== */
let look=false, lx=0, ly=0;
renderer.domElement.addEventListener("pointerdown",e=>{
  if(e.clientX < innerWidth*0.5) return;
  look=true; lx=e.clientX; ly=e.clientY;
});
window.addEventListener("pointermove",e=>{
  if(!look) return;
  yaw -= (e.clientX-lx)*0.005;
  pitch -= (e.clientY-ly)*0.005;
  pitch = Math.max(-0.6,Math.min(0.4,pitch));
  lx=e.clientX; ly=e.clientY;
});
window.addEventListener("pointerup",()=>look=false);

/* ====== تفاعل ====== */
document.getElementById("interact").onclick=()=>{
  car.material.color.set(0x00ff00);
};

/* ====== حلقة ====== */
function animate(){
  requestAnimationFrame(animate);

  /* اتجاه حركة ثابت */
  if(moving){
    moveDir.set(joyX,0,joyY).normalize();
    const angle = yaw;
    const sin = Math.sin(angle), cos = Math.cos(angle);
    velocity.x = (moveDir.x*cos - moveDir.z*sin)*0.08;
    velocity.z = (moveDir.x*sin + moveDir.z*cos)*0.08;
  } else {
    velocity.multiplyScalar(0.85);
  }

  player.position.add(velocity);

  /* تدوير اللاعب باتجاه الحركة */
  if(velocity.length()>0.01){
    player.rotation.y = Math.atan2(velocity.x,velocity.z);
  }

  /* كاميرا Third Person */
  const camOffset = new THREE.Vector3(0,2,5);
  camOffset.applyAxisAngle(new THREE.Vector3(0,1,0),yaw);
  camera.position.copy(player.position).add(camOffset);
  camera.lookAt(player.position.x,player.position.y+1,player.position.z);

  renderer.render(scene,camera);
}
animate();

/* ====== Resize ====== */
addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
