<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Mechanical Duo – Stable Repair Base</title>
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#000}
#ui{
  position:fixed;
  bottom:20px;
  right:20px;
  z-index:10;
}
button{
  padding:14px 20px;
  font-size:16px;
  border:none;
  border-radius:10px;
  background:#ff9800;
  color:#000;
}
</style>
</head>
<body>

<div id="ui">
  <button id="interactBtn">تفاعل</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
// ================== مشهد ==================
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x202020);

// ================== كاميرا ==================
const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
camera.position.set(0,2,6);

// ================== ريندر ==================
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

// ================== إضاءة ==================
scene.add(new THREE.AmbientLight(0xffffff,0.4));
const dl=new THREE.DirectionalLight(0xffffff,1);
dl.position.set(5,10,5);
scene.add(dl);

// ================== أرض ==================
const floor=new THREE.Mesh(
  new THREE.PlaneGeometry(30,30),
  new THREE.MeshStandardMaterial({color:0x555555})
);
floor.rotation.x=-Math.PI/2;
scene.add(floor);

// ================== لاعب ==================
const player=new THREE.Mesh(
  new THREE.CapsuleGeometry(0.4,1.2,4,8),
  new THREE.MeshStandardMaterial({color:0x00ffcc})
);
player.position.set(0,1,8); // بعيد عن السيارة
scene.add(player);

// ================== سيارة ==================
const carMat=new THREE.MeshStandardMaterial({color:0xaa0000});
const car=new THREE.Mesh(
  new THREE.BoxGeometry(2,1,4),
  carMat
);
car.position.set(0,0.5,0);
scene.add(car);

// ================== حالة اللعبة ==================
let gameState="walk";

// ================== تحكم الكاميرا ==================
let camYaw=0,camPitch=0;
let lookTouch=null;

window.addEventListener("touchstart",e=>{
  if(e.touches[0].clientX>innerWidth/2){
    lookTouch=e.touches[0];
  }
});
window.addEventListener("touchmove",e=>{
  if(!lookTouch)return;
  const t=e.touches[0];
  camYaw-= (t.clientX-lookTouch.clientX)*0.003;
  camPitch-= (t.clientY-lookTouch.clientY)*0.003;
  camPitch=Math.max(-1.2,Math.min(1.2,camPitch));
  lookTouch=t;
});
window.addEventListener("touchend",()=>lookTouch=null);

// ================== زر التفاعل ==================
document.getElementById("interactBtn").onclick=()=>{
  if(gameState!=="walk")return;

  // فحص المسافة
  const dist=player.position.distanceTo(car.position);
  if(dist>3)return;

  gameState="repair";

  // إخفاء اللاعب
  player.visible=false;

  // تغيير لون السيارة
  carMat.color.set(0x00ff00);

  // نقل الكاميرا
  camera.position.set(0,1.8,2.5);
  camYaw=0;
  camPitch=-0.3;
};

// ================== التحديث ==================
function animate(){
  requestAnimationFrame(animate);

  if(gameState==="walk"){
    player.rotation.y=camYaw;
    camera.position.set(
      player.position.x,
      player.position.y+1,
      player.position.z
    );
  }

  camera.rotation.order="YXZ";
  camera.rotation.y=camYaw;
  camera.rotation.x=camPitch;

  renderer.render(scene,camera);
}
animate();

window.onresize=()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
};
</script>
</body>
</html>
