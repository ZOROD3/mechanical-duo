<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Mechanical Duo – Stable Final Control</title>
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#000}
#interact{
  position:fixed;
  bottom:20px;
  right:20px;
  z-index:10;
  padding:14px 20px;
  border:none;
  border-radius:10px;
  background:#ff9800;
  font-size:16px;
}
#joyBase{
  position:fixed;
  bottom:30px;
  left:30px;
  width:120px;
  height:120px;
  border-radius:50%;
  background:rgba(255,255,255,0.15);
}
#joyStick{
  position:absolute;
  left:40px;
  top:40px;
  width:40px;
  height:40px;
  border-radius:50%;
  background:rgba(255,255,255,0.6);
}
</style>
</head>
<body>

<div id="joyBase"><div id="joyStick"></div></div>
<button id="interact">تفاعل</button>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
// ===== مشهد =====
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x202020);

// ===== كاميرا =====
const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
camera.position.set(0,2,6);

// ===== ريندر =====
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

// ===== إضاءة =====
scene.add(new THREE.AmbientLight(0xffffff,0.4));
const dl=new THREE.DirectionalLight(0xffffff,1);
dl.position.set(5,10,5);
scene.add(dl);

// ===== أرض =====
const floor=new THREE.Mesh(
  new THREE.PlaneGeometry(40,40),
  new THREE.MeshStandardMaterial({color:0x555555})
);
floor.rotation.x=-Math.PI/2;
scene.add(floor);

// ===== لاعب =====
const player=new THREE.Mesh(
  new THREE.CapsuleGeometry(0.4,1.2,4,8),
  new THREE.MeshStandardMaterial({color:0x00ffcc})
);
player.position.set(0,1,10);
scene.add(player);

// ===== سيارة =====
const carMat=new THREE.MeshStandardMaterial({color:0xaa0000});
const car=new THREE.Mesh(
  new THREE.BoxGeometry(2,1,4),
  carMat
);
car.position.set(0,0.5,0);
scene.add(car);

// ===== حالة =====
let gameState="walk";

// ===== متغيرات =====
let camYaw=0,camPitch=0;
let moveX=0,moveZ=0;
let joyTouch=null;

// ===== Joystick =====
const joyBase=document.getElementById("joyBase");
const joyStick=document.getElementById("joyStick");

joyBase.addEventListener("touchstart",e=>{
  joyTouch=e.touches[0];
});
joyBase.addEventListener("touchmove",e=>{
  if(!joyTouch || gameState!=="walk")return;
  const t=e.touches[0];
  const dx=t.clientX-joyTouch.clientX;
  const dy=t.clientY-joyTouch.clientY;

  moveX=Math.max(-1,Math.min(1,dx/40));
  moveZ=Math.max(-1,Math.min(1,dy/40)); // ✅ صح

  joyStick.style.left=40+moveX*30+"px";
  joyStick.style.top=40+moveZ*30+"px";
});
joyBase.addEventListener("touchend",()=>{
  moveX=moveZ=0;
  joyStick.style.left="40px";
  joyStick.style.top="40px";
  joyTouch=null;
});

// ===== تحريك الكاميرا (في المشي + التصليح) =====
let lookTouch=null;
window.addEventListener("touchstart",e=>{
  if(e.touches[0].clientX>innerWidth/2){
    lookTouch=e.touches[0];
  }
});
window.addEventListener("touchmove",e=>{
  if(!lookTouch)return;
  const t=e.touches[0];
  camYaw-=(t.clientX-lookTouch.clientX)*0.003;
  camPitch-=(t.clientY-lookTouch.clientY)*0.003;
  camPitch=Math.max(-1.2,Math.min(1.2,camPitch));
  lookTouch=t;
});
window.addEventListener("touchend",()=>lookTouch=null);

// ===== زر =====
const btn=document.getElementById("interact");
btn.onclick=()=>{
  if(gameState==="walk" && player.position.distanceTo(car.position)<3){
    gameState="repair";
    player.visible=false;
    carMat.color.set(0x00ff00);
    camera.position.set(0,1.8,2.5);
    camPitch=-0.3;
    btn.textContent="رجوع";
  }else if(gameState==="repair"){
    gameState="walk";
    player.visible=true;
    carMat.color.set(0xaa0000);
    btn.textContent="تفاعل";
  }
};

// ===== تحديث =====
function animate(){
  requestAnimationFrame(animate);

  if(gameState==="walk"){
    const speed=0.08;
    player.position.x+=
      (moveX*Math.cos(camYaw)-moveZ*Math.sin(camYaw))*speed;
    player.position.z+=
      (moveZ*Math.cos(camYaw)+moveX*Math.sin(camYaw))*speed;

    player.rotation.y=camYaw;
    camera.position.set(
      player.position.x,
      player.position.y+1,
      player.position.z
    );
  }

  camera.rotation.order="YXZ";
  camera.rotation.y=camYaw;
  camera.rotation.x=camPitch;

  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
