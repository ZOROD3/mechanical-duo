<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Mechanical Duo ‚Äì First Person Repair</title>

<style>
body{
  margin:0;
  overflow:hidden;
  background:#000;
  touch-action:none;
}

/* ===== Joystick ===== */
#joystick{
  position:fixed;
  bottom:30px;
  left:30px;
  width:150px;
  height:150px;
  border-radius:50%;
  background:rgba(255,255,255,0.15);
  border:2px solid rgba(255,255,255,0.3);
}
#stick{
  position:absolute;
  left:50%;
  top:50%;
  width:60px;
  height:60px;
  margin-left:-30px;
  margin-top:-30px;
  border-radius:50%;
  background:rgba(255,255,255,0.7);
}

/* ===== Interaction Button ===== */
#interact{
  position:fixed;
  bottom:40px;
  right:40px;
  width:90px;
  height:90px;
  border-radius:50%;
  background:#ff9800;
  border:none;
  font-size:16px;
  font-weight:bold;
}
</style>
</head>

<body>

<div id="joystick"><div id="stick"></div></div>
<button id="interact">ÿ™ŸÅÿßÿπŸÑ</button>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

<script>
/* ===== Scene ===== */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x202020);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

/* ===== Player ===== */
const player = new THREE.Mesh(
  new THREE.CapsuleGeometry(0.4,1.2,4,8),
  new THREE.MeshStandardMaterial({color:0x00aaff})
);
player.position.set(0,1,5);
scene.add(player);

/* ===== Camera ===== */
const camera = new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,1000);

/* ===== Light ===== */
scene.add(new THREE.AmbientLight(0xffffff,0.6));
const light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(5,10,5);
scene.add(light);

/* ===== Ground ===== */
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(60,60),
  new THREE.MeshStandardMaterial({color:0x555555})
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

/* ===== Car ===== */
const carMat = new THREE.MeshStandardMaterial({color:0xaa0000});
const car = new THREE.Mesh(
  new THREE.BoxGeometry(2,1,4),
  carMat
);
car.position.set(0,0.5,0);
scene.add(car);

/* ===== States ===== */
let repairMode = false;

/* ===== Joystick ===== */
const joystick = document.getElementById("joystick");
const stick = document.getElementById("stick");

/* ===== Camera Look ===== */
let camYaw = 0;
let camPitch = -0.3; // ŸÜÿ∏ÿ±ÿ© ÿÆŸÅŸäŸÅÿ© ŸÑŸÑÿ£ÿ≥ŸÅŸÑ
let lookId = null;
let lastX = 0;
let lastY = 0;

/* ===== Touch Look ===== */
window.addEventListener("touchstart",e=>{
  if(!repairMode) return;
  for(const t of e.changedTouches){
    if(t.clientX > innerWidth/2 && lookId === null){
      lookId = t.identifier;
      lastX = t.clientX;
      lastY = t.clientY;
    }
  }
});

window.addEventListener("touchmove",e=>{
  if(!repairMode) return;
  for(const t of e.changedTouches){
    if(t.identifier === lookId){
      camYaw   -= (t.clientX - lastX) * 0.004;
      camPitch -= (t.clientY - lastY) * 0.004;

      camPitch = Math.max(-1.2, Math.min(0.2, camPitch)); // ÿ≠ÿØŸàÿØ ÿßŸÑŸÜÿ∏ÿ±

      lastX = t.clientX;
      lastY = t.clientY;
    }
  }
});

window.addEventListener("touchend",e=>{
  for(const t of e.changedTouches){
    if(t.identifier === lookId) lookId = null;
  }
});

/* ===== Animate ===== */
function animate(){
  requestAnimationFrame(animate);

  if(!repairMode){
    // ŸÑÿπÿ® ÿπÿßÿØŸä (ÿ´ÿßÿ®ÿ™)
    camera.position.set(
      player.position.x,
      player.position.y + 3,
      player.position.z + 6
    );
    camera.lookAt(player.position);
  }else{
    // ŸÖŸÜÿ∏Ÿàÿ± ÿßŸÑÿ™ÿµŸÑŸäÿ≠ ÿßŸÑŸàÿßŸÇÿπŸä
    const lookDir = new THREE.Vector3(
      Math.sin(camYaw) * Math.cos(camPitch),
      Math.sin(camPitch),
      Math.cos(camYaw) * Math.cos(camPitch)
    );

    camera.position.set(
      car.position.x,
      car.position.y + 1.6,
      car.position.z + 1.8
    );

    camera.lookAt(
      camera.position.clone().add(lookDir)
    );
  }

  renderer.render(scene,camera);
}
animate();

/* ===== Interaction ===== */
document.getElementById("interact").onclick = ()=>{
  const dist = player.position.distanceTo(car.position);
  if(dist < 2.5){
    repairMode = !repairMode;

    if(repairMode){
      player.visible = false;      // üë§ ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÑÿßÿπÿ®
      joystick.style.opacity = "0.3";
      carMat.color.set(0x00ff00);
    }else{
      player.visible = true;
      joystick.style.opacity = "1";
      carMat.color.set(0xaa0000);
    }
  }else{
    alert("ÿßŸÇÿ™ÿ±ÿ® ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿßÿ±ÿ©");
  }
};

/* ===== Resize ===== */
window.addEventListener("resize",()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>

</body>
</html>
