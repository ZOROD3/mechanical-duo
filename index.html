<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Mechanical Duo – Stable Movement</title>
<style>
body { margin:0; overflow:hidden; background:#000; touch-action:none; }
#ui {
  position:fixed; inset:0; pointer-events:none;
}
.joystick {
  position:absolute;
  left:20px; bottom:20px;
  width:140px; height:140px;
  border-radius:50%;
  background:rgba(255,255,255,0.1);
  pointer-events:auto;
}
.stick {
  position:absolute;
  left:50%; top:50%;
  width:60px; height:60px;
  margin:-30px;
  border-radius:50%;
  background:rgba(255,255,255,0.4);
}
#interact {
  position:absolute;
  right:20px; bottom:60px;
  padding:14px 22px;
  background:#ffc107;
  color:#000;
  font-weight:bold;
  border-radius:12px;
  pointer-events:auto;
}
</style>
</head>
<body>

<div id="ui">
  <div class="joystick" id="joy">
    <div class="stick" id="stick"></div>
  </div>
  <div id="interact">تفاعل</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
/* ===== Scene ===== */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x202020);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0,1.6,6);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

/* ===== Lights ===== */
scene.add(new THREE.AmbientLight(0xffffff,0.5));
const dl = new THREE.DirectionalLight(0xffffff,1);
dl.position.set(5,10,5);
scene.add(dl);

/* ===== Floor ===== */
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(50,50),
  new THREE.MeshStandardMaterial({color:0x555555})
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

/* ===== Player ===== */
const player = new THREE.Object3D();
player.position.set(0,0,5);
scene.add(player);

/* ===== Car ===== */
const carMat = new THREE.MeshStandardMaterial({color:0xaa0000});
const car = new THREE.Mesh(
  new THREE.BoxGeometry(2,1,4),
  carMat
);
car.position.set(0,0.5,0);
scene.add(car);

/* ===== Camera control ===== */
let camYaw = 0, camPitch = 0;
let touchingCam = false;
let lastX=0,lastY=0;

window.addEventListener("touchstart",e=>{
  if(e.touches[0].clientX > innerWidth/2){
    touchingCam = true;
    lastX = e.touches[0].clientX;
    lastY = e.touches[0].clientY;
  }
});
window.addEventListener("touchmove",e=>{
  if(!touchingCam) return;
  const dx = e.touches[0].clientX-lastX;
  const dy = e.touches[0].clientY-lastY;
  camYaw -= dx*0.003;
  camPitch -= dy*0.002;
  camPitch = Math.max(-1.2,Math.min(1.2,camPitch));
  lastX=e.touches[0].clientX;
  lastY=e.touches[0].clientY;
});
window.addEventListener("touchend",()=>touchingCam=false);

/* ===== Joystick ===== */
const joy = document.getElementById("joy");
const stick = document.getElementById("stick");
let joyActive=false;
let joyVec={x:0,z:0};
let moveDir = new THREE.Vector3();

joy.addEventListener("touchstart",e=>{
  joyActive=true;
});
joy.addEventListener("touchmove",e=>{
  const r=70;
  const rect=joy.getBoundingClientRect();
  const x=e.touches[0].clientX-rect.left-r;
  const y=e.touches[0].clientY-rect.top-r;
  const d=Math.min(r,Math.hypot(x,y));
  const a=Math.atan2(y,x);
  stick.style.transform=`translate(${Math.cos(a)*d}px,${Math.sin(a)*d}px)`;
  joyVec.x = Math.cos(a)*(d/r);
  joyVec.z = Math.sin(a)*(d/r);

  if(joyActive){
    moveDir.set(
      Math.sin(camYaw)*joyVec.z + Math.cos(camYaw)*joyVec.x,
      0,
      Math.cos(camYaw)*joyVec.z - Math.sin(camYaw)*joyVec.x
    ).normalize();
  }
});
joy.addEventListener("touchend",()=>{
  joyActive=false;
  joyVec.x=joyVec.z=0;
  stick.style.transform="translate(0,0)";
});

/* ===== Interaction ===== */
let repairing=false;
document.getElementById("interact").onclick=()=>{
  repairing=!repairing;
  carMat.color.set(repairing?0x00ff88:0xaa0000);
};

/* ===== Loop ===== */
function animate(){
  requestAnimationFrame(animate);

  if(!repairing && joyActive){
    player.position.addScaledVector(moveDir,0.08);
  }

  camera.position.set(
    player.position.x + Math.sin(camYaw)*4,
    player.position.y + 2,
    player.position.z + Math.cos(camYaw)*4
  );
  camera.lookAt(player.position);

  renderer.render(scene,camera);
}
animate();

window.addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
